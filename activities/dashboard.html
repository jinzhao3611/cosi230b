<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Response Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
        }

        .session-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .session-controls input, .session-controls select {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .session-controls input {
            width: 150px;
            text-transform: uppercase;
        }

        .session-controls select {
            min-width: 200px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .stats-bar {
            background: rgba(255,255,255,0.05);
            padding: 15px 40px;
            display: flex;
            gap: 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255,255,255,0.7);
        }

        .main-content {
            padding: 30px 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 .question-num {
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-bottom: 15px;
        }

        .agreement-metrics {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .metric {
            text-align: center;
            flex: 1;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .metric-value.excellent { color: #4CAF50; }
        .metric-value.good { color: #8BC34A; }
        .metric-value.moderate { color: #FFC107; }
        .metric-value.fair { color: #FF9800; }
        .metric-value.poor { color: #f44336; }

        .metric-label {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
        }

        .text-responses {
            max-height: 300px;
            overflow-y: auto;
        }

        .text-response {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.95em;
            line-height: 1.5;
            border-left: 3px solid #4CAF50;
        }

        .text-response:nth-child(even) {
            border-left-color: #2196F3;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #4CAF50;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            backdrop-filter: blur(10px);
        }

        .fullscreen-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        body.presentation-mode .header {
            padding: 10px 20px;
        }

        body.presentation-mode .main-content {
            padding: 15px 20px;
        }

        body.presentation-mode .card {
            padding: 15px;
        }

        .connection-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 40px;
        }

        .empty-state h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: rgba(255,255,255,0.8);
        }

        .empty-state p {
            color: rgba(255,255,255,0.5);
            font-size: 1.1em;
            max-width: 500px;
            margin: 0 auto;
        }

        .session-code-display {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 8px;
            color: #4CAF50;
            text-align: center;
            padding: 20px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.7;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .session-list {
            margin-top: 20px;
        }

        .session-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .session-item:hover {
            background: rgba(255,255,255,0.08);
        }

        .session-info {
            flex: 1;
        }

        .session-code {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            letter-spacing: 2px;
        }

        .session-meta {
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }

        .session-worksheets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .worksheet-tag {
            background: rgba(33, 150, 243, 0.3);
            color: #90caf9;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }

        .session-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .no-sessions {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.5);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .storage-info {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .storage-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .storage-bar-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .confirm-dialog {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .confirm-dialog p {
            margin-bottom: 15px;
        }

        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Annotation Worksheet Dashboard</h1>
        <div class="session-controls">
            <input type="text" id="sessionCode" placeholder="Session Code" maxlength="6">
            <select id="worksheetSelect">
                <option value="">Select Worksheet...</option>
            </select>
            <button class="btn btn-primary" onclick="startSession()">Start Viewing</button>
            <button class="btn btn-secondary" onclick="generateSessionCode()">New Session</button>
            <button class="btn btn-warning" onclick="openSessionManager()">Manage Sessions</button>
            <span class="connection-status disconnected" id="connectionStatus">Disconnected</span>
        </div>
    </div>

    <div class="stats-bar" id="statsBar" style="display: none;">
        <div class="stat-item">
            <div class="stat-value" id="totalResponses">0</div>
            <div class="stat-label">Total Responses</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgAgreement">--</div>
            <div class="stat-label">Avg. Agreement</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgKappa">--</div>
            <div class="stat-label">Fleiss' Kappa</div>
        </div>
        <div class="stat-item">
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="stat-label" id="lastUpdate">Waiting for responses...</div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="empty-state">
            <h2>Welcome to the Dashboard</h2>
            <p>Enter a session code and select a worksheet to view real-time student responses and statistics.</p>
            <p style="margin-top: 20px;">Or click "New Session" to generate a new session code for your class.</p>
        </div>
    </div>

    <button class="fullscreen-btn" onclick="toggleFullscreen()">&#x26F6; Fullscreen</button>

    <!-- Session Manager Modal -->
    <div class="modal-overlay" id="sessionModal">
        <div class="modal">
            <h2>
                Session Manager
                <button class="modal-close" onclick="closeSessionManager()">&times;</button>
            </h2>

            <div class="storage-info">
                <strong>Storage Usage</strong>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span id="storageUsed">Calculating...</span>
                    <span style="color: rgba(255,255,255,0.5);">Free tier: 1 GB</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-bar-fill" id="storageBar" style="width: 0%"></div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>All Sessions</h3>
                <button class="btn btn-danger btn-sm" onclick="confirmDeleteAll()" id="deleteAllBtn" style="display: none;">Delete All Sessions</button>
            </div>

            <div class="session-list" id="sessionList">
                <div class="loading"></div>
            </div>

            <div class="confirm-dialog" id="confirmDialog" style="display: none;">
                <p id="confirmMessage">Are you sure you want to delete this session? This cannot be undone.</p>
                <div class="confirm-actions">
                    <button class="btn btn-secondary btn-sm" onclick="cancelDelete()">Cancel</button>
                    <button class="btn btn-danger btn-sm" onclick="executeDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Worksheet definitions
        const worksheets = {
            'toxicity': { name: 'Toxicity Detection', file: 'toxicity-worksheet.html' },
            'event-extraction': { name: 'Event Extraction', file: 'event-extraction-worksheet.html' },
            'causal-relation': { name: 'Causal Relation', file: 'causal-relation-worksheet.html' },
            'ner': { name: 'Named Entity Recognition', file: 'ner-worksheet.html' },
            'sentiment': { name: 'Sentiment Analysis', file: 'sentiment-worksheet.html' },
            'coreference': { name: 'Coreference Resolution', file: 'coreference-worksheet.html' },
            'llm-preference': { name: 'LLM Preference (RLHF)', file: 'llm-preference-worksheet.html' },
            'hallucination': { name: 'Hallucination Detection', file: 'hallucination-worksheet.html' },
            'sarcasm': { name: 'Sarcasm Detection', file: 'sarcasm-worksheet.html' },
            'stance-detection': { name: 'Stance Detection', file: 'stance-detection-worksheet.html' },
            'qa-annotation': { name: 'Question Answering', file: 'qa-annotation-worksheet.html' },
            'summarization-eval': { name: 'Summarization Evaluation', file: 'summarization-eval-worksheet.html' },
            'emotion-detection': { name: 'Emotion Detection', file: 'emotion-detection-worksheet.html' },
            'semantic-role': { name: 'Semantic Role Labeling', file: 'semantic-role-worksheet.html' },
            'prompt-quality': { name: 'Prompt Quality', file: 'prompt-quality-worksheet.html' },
            'word-sense': { name: 'Word Sense Disambiguation', file: 'word-sense-worksheet.html' },
            'dialogue-act': { name: 'Dialogue Act Classification', file: 'dialogue-act-worksheet.html' },
            'temporal-annotation': { name: 'Temporal Annotation', file: 'temporal-annotation-worksheet.html' },
            'implicit-hate': { name: 'Implicit Hate Speech', file: 'implicit-hate-worksheet.html' },
            'translation-quality': { name: 'Translation Quality', file: 'translation-quality-worksheet.html' },
            'code-review': { name: 'Code Review', file: 'code-review-worksheet.html' },
            'relation-extraction': { name: 'Relation Extraction', file: 'relation-extraction-worksheet.html' },
            'argumentation': { name: 'Argumentation Mining', file: 'argumentation-worksheet.html' },
            'text-simplification': { name: 'Text Simplification', file: 'text-simplification-worksheet.html' },
            'bias-detection': { name: 'Bias Detection', file: 'bias-detection-worksheet.html' }
        };

        const chartColors = [
            'rgba(76, 175, 80, 0.8)',
            'rgba(33, 150, 243, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(156, 39, 176, 0.8)',
            'rgba(255, 87, 34, 0.8)',
            'rgba(0, 188, 212, 0.8)',
            'rgba(233, 30, 99, 0.8)',
            'rgba(139, 195, 74, 0.8)'
        ];

        let db = null;
        let unsubscribe = null;
        let currentSession = null;
        let currentWorksheet = null;
        let charts = {};
        let allResponses = [];
        let deleteTarget = null;

        // Initialize worksheet dropdown
        function initWorksheetSelect() {
            const select = document.getElementById('worksheetSelect');
            Object.entries(worksheets).forEach(([id, info]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = info.name;
                select.appendChild(option);
            });
        }

        // Generate random session code
        function generateSessionCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('sessionCode').value = code;

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <h2>Session Created!</h2>
                    <p>Share this code with your students:</p>
                    <div class="session-code-display">${code}</div>
                    <p style="margin-top: 20px;">Students should enter this code in their worksheet before submitting.</p>
                    <p style="margin-top: 10px;">Select a worksheet above and click "Start Viewing" to begin.</p>
                </div>
            `;
        }

        // Initialize Firebase
        function initFirebase() {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase initialized');
                return true;
            } else {
                console.warn('Firebase config not found');
                return false;
            }
        }

        // Session Manager Functions
        function openSessionManager() {
            document.getElementById('sessionModal').classList.add('show');
            loadAllSessions();
        }

        function closeSessionManager() {
            document.getElementById('sessionModal').classList.remove('show');
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function loadAllSessions() {
            const sessionList = document.getElementById('sessionList');
            sessionList.innerHTML = '<div class="loading"></div>';

            if (!db) {
                sessionList.innerHTML = '<div class="no-sessions">Firebase not configured. Running in demo mode.</div>';
                document.getElementById('storageUsed').textContent = 'Demo mode - no data stored';
                return;
            }

            try {
                const sessionsRef = db.collection('sessions');
                const sessionsSnapshot = await sessionsRef.get();

                if (sessionsSnapshot.empty) {
                    sessionList.innerHTML = '<div class="no-sessions">No sessions found. Create a new session to get started.</div>';
                    document.getElementById('storageUsed').textContent = '0 sessions, 0 responses';
                    document.getElementById('deleteAllBtn').style.display = 'none';
                    return;
                }

                const sessions = [];
                let totalResponses = 0;

                for (const sessionDoc of sessionsSnapshot.docs) {
                    const sessionCode = sessionDoc.id;
                    const worksheetData = [];

                    // Get all worksheets in this session
                    const collections = await sessionDoc.ref.listCollections();

                    for (const collection of collections) {
                        const worksheetSnap = await collection.get();
                        const count = worksheetSnap.size;
                        totalResponses += count;
                        if (count > 0) {
                            worksheetData.push({
                                id: collection.id,
                                name: worksheets[collection.id]?.name || collection.id,
                                count: count
                            });
                        }
                    }

                    if (worksheetData.length > 0) {
                        sessions.push({
                            code: sessionCode,
                            worksheets: worksheetData,
                            totalResponses: worksheetData.reduce((sum, w) => sum + w.count, 0)
                        });
                    }
                }

                // Update storage info
                document.getElementById('storageUsed').textContent = `${sessions.length} session(s), ${totalResponses} total responses`;
                const storagePercent = Math.min((totalResponses * 0.001), 100); // Rough estimate
                document.getElementById('storageBar').style.width = storagePercent + '%';

                if (sessions.length === 0) {
                    sessionList.innerHTML = '<div class="no-sessions">No sessions with data found.</div>';
                    document.getElementById('deleteAllBtn').style.display = 'none';
                    return;
                }

                document.getElementById('deleteAllBtn').style.display = 'block';

                // Render sessions
                sessionList.innerHTML = sessions.map(session => `
                    <div class="session-item">
                        <div class="session-info">
                            <div class="session-code">${session.code}</div>
                            <div class="session-meta">${session.totalResponses} responses</div>
                            <div class="session-worksheets">
                                ${session.worksheets.map(w => `<span class="worksheet-tag">${w.name} (${w.count})</span>`).join('')}
                            </div>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewSession('${session.code}')">View</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteSession('${session.code}')">Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading sessions:', error);
                sessionList.innerHTML = '<div class="no-sessions">Error loading sessions. Check console for details.</div>';
            }
        }

        function viewSession(code) {
            document.getElementById('sessionCode').value = code;
            closeSessionManager();
        }

        function confirmDeleteSession(code) {
            deleteTarget = { type: 'session', code: code };
            document.getElementById('confirmMessage').textContent =
                `Are you sure you want to delete session "${code}" and all its responses? This cannot be undone.`;
            document.getElementById('confirmDialog').style.display = 'block';
        }

        function confirmDeleteAll() {
            deleteTarget = { type: 'all' };
            document.getElementById('confirmMessage').textContent =
                'Are you sure you want to delete ALL sessions and responses? This cannot be undone.';
            document.getElementById('confirmDialog').style.display = 'block';
        }

        function cancelDelete() {
            deleteTarget = null;
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function executeDelete() {
            if (!deleteTarget || !db) return;

            document.getElementById('confirmDialog').style.display = 'none';
            document.getElementById('sessionList').innerHTML = '<div class="loading"></div>';

            try {
                if (deleteTarget.type === 'session') {
                    await deleteSession(deleteTarget.code);
                } else if (deleteTarget.type === 'all') {
                    const sessionsSnapshot = await db.collection('sessions').get();
                    for (const doc of sessionsSnapshot.docs) {
                        await deleteSession(doc.id);
                    }
                }

                deleteTarget = null;
                loadAllSessions();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Error deleting session. Check console for details.');
                loadAllSessions();
            }
        }

        async function deleteSession(code) {
            const sessionRef = db.collection('sessions').doc(code);
            const collections = await sessionRef.listCollections();

            for (const collection of collections) {
                const docs = await collection.get();
                const batch = db.batch();
                docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }

            await sessionRef.delete();
        }

        // Start viewing session
        function startSession() {
            const sessionCode = document.getElementById('sessionCode').value.toUpperCase().trim();
            const worksheetId = document.getElementById('worksheetSelect').value;

            if (!sessionCode) {
                alert('Please enter a session code');
                return;
            }

            if (!worksheetId) {
                alert('Please select a worksheet');
                return;
            }

            if (!db) {
                startDemoMode(sessionCode, worksheetId);
                return;
            }

            currentSession = sessionCode;
            currentWorksheet = worksheetId;

            if (unsubscribe) {
                unsubscribe();
            }

            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').textContent = 'Connected';

            unsubscribe = db.collection('sessions')
                .doc(sessionCode)
                .collection(worksheetId)
                .onSnapshot((snapshot) => {
                    allResponses = [];
                    snapshot.forEach(doc => {
                        allResponses.push(doc.data());
                    });
                    updateDashboard(allResponses);
                }, (error) => {
                    console.error('Error listening to updates:', error);
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = 'Error';
                });
        }

        function startDemoMode(sessionCode, worksheetId) {
            currentSession = sessionCode;
            currentWorksheet = worksheetId;

            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').textContent = 'Demo Mode';

            const demoResponses = generateDemoData(worksheetId);
            allResponses = demoResponses;
            updateDashboard(demoResponses);

            setInterval(() => {
                if (Math.random() > 0.7) {
                    allResponses.push(generateSingleDemoResponse(worksheetId));
                    updateDashboard(allResponses);
                }
            }, 3000);
        }

        function generateDemoData(worksheetId) {
            const responses = [];
            const numResponses = Math.floor(Math.random() * 15) + 10;
            for (let i = 0; i < numResponses; i++) {
                responses.push(generateSingleDemoResponse(worksheetId));
            }
            return responses;
        }

        function generateSingleDemoResponse(worksheetId) {
            const response = { timestamp: new Date().toISOString(), answers: {} };
            for (let i = 1; i <= 8; i++) {
                if (Math.random() < 0.7) {
                    const options = ['A', 'B', 'C', 'D'];
                    response.answers[`q${i}`] = options[Math.floor(Math.random() * options.length)];
                } else {
                    const texts = ["The context makes it ambiguous.", "Clear case.", "Multiple valid interpretations.", "Guidelines unclear."];
                    response.answers[`q${i}_text`] = texts[Math.floor(Math.random() * texts.length)];
                }
            }
            return response;
        }

        function updateDashboard(responses) {
            document.getElementById('totalResponses').textContent = responses.length;
            document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;

            if (responses.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="empty-state">
                        <h2>Waiting for Responses</h2>
                        <p>Session Code: <strong>${currentSession}</strong></p>
                        <p>Worksheet: <strong>${worksheets[currentWorksheet].name}</strong></p>
                        <p style="margin-top: 20px;">Responses will appear here in real-time as students submit.</p>
                    </div>
                `;
                return;
            }

            const analysis = analyzeResponses(responses);
            renderDashboard(analysis);
            document.getElementById('avgAgreement').textContent = analysis.avgAgreement.toFixed(0) + '%';
            document.getElementById('avgKappa').textContent = analysis.avgKappa.toFixed(2);
        }

        function analyzeResponses(responses) {
            const questions = {};
            const textResponses = {};

            responses.forEach(response => {
                Object.entries(response.answers || {}).forEach(([key, value]) => {
                    if (key.endsWith('_text')) {
                        const qKey = key.replace('_text', '');
                        if (!textResponses[qKey]) textResponses[qKey] = [];
                        if (value && value.trim()) textResponses[qKey].push(value);
                    } else {
                        if (!questions[key]) questions[key] = {};
                        if (!questions[key][value]) questions[key][value] = 0;
                        questions[key][value]++;
                    }
                });
            });

            let totalAgreement = 0, totalKappa = 0, questionCount = 0;

            const questionAnalysis = Object.entries(questions).map(([qId, distribution]) => {
                const total = Object.values(distribution).reduce((a, b) => a + b, 0);
                const options = Object.keys(distribution).sort();
                const counts = options.map(opt => distribution[opt] || 0);
                const maxCount = Math.max(...counts);
                const agreement = (maxCount / total) * 100;
                const kappa = calculateFleissKappa(counts, total);

                totalAgreement += agreement;
                totalKappa += kappa;
                questionCount++;

                return { id: qId, distribution, options, counts, total, agreement, kappa, textResponses: textResponses[qId] || [] };
            });

            return {
                questions: questionAnalysis.sort((a, b) => parseInt(a.id.replace('q', '')) - parseInt(b.id.replace('q', ''))),
                avgAgreement: questionCount > 0 ? totalAgreement / questionCount : 0,
                avgKappa: questionCount > 0 ? totalKappa / questionCount : 0,
                totalResponses: responses.length
            };
        }

        function calculateFleissKappa(counts, n) {
            if (n < 2) return 0;
            const pj = counts.map(c => c / n);
            const Pe = pj.reduce((sum, p) => sum + p * p, 0);
            const Po = counts.reduce((sum, c) => sum + (c * (c - 1)), 0) / (n * (n - 1) || 1);
            if (Pe === 1) return 1;
            return Math.max(-1, Math.min(1, (Po - Pe) / (1 - Pe)));
        }

        function getKappaClass(kappa) {
            if (kappa >= 0.8) return 'excellent';
            if (kappa >= 0.6) return 'good';
            if (kappa >= 0.4) return 'moderate';
            if (kappa >= 0.2) return 'fair';
            return 'poor';
        }

        function renderDashboard(analysis) {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            analysis.questions.forEach((q) => {
                const card = document.createElement('div');
                card.className = 'card';
                const questionNum = q.id.replace('q', '');
                const kappaClass = getKappaClass(q.kappa);

                card.innerHTML = `
                    <h3><span class="question-num">Q${questionNum}</span> Response Distribution</h3>
                    <div class="chart-container"><canvas id="chart-${q.id}"></canvas></div>
                    <div class="agreement-metrics">
                        <div class="metric"><div class="metric-value ${kappaClass}">${q.agreement.toFixed(0)}%</div><div class="metric-label">Agreement</div></div>
                        <div class="metric"><div class="metric-value ${kappaClass}">${q.kappa.toFixed(2)}</div><div class="metric-label">Fleiss' Kappa</div></div>
                        <div class="metric"><div class="metric-value">${q.total}</div><div class="metric-label">Responses</div></div>
                    </div>
                    ${q.textResponses.length > 0 ? `
                        <div style="margin-top: 15px;"><h4 style="margin-bottom: 10px; color: rgba(255,255,255,0.8);">Text Responses</h4>
                        <div class="text-responses">${q.textResponses.map(t => `<div class="text-response">${escapeHtml(t)}</div>`).join('')}</div></div>
                    ` : ''}
                `;
                container.appendChild(card);

                const ctx = document.getElementById(`chart-${q.id}`).getContext('2d');
                charts[q.id] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: q.options,
                        datasets: [{ data: q.counts, backgroundColor: q.options.map((_, i) => chartColors[i % chartColors.length]), borderWidth: 0, borderRadius: 5 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.7)', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: 'rgba(255,255,255,0.9)' }, grid: { display: false } }
                        }
                    }
                });
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.body.classList.add('presentation-mode');
            } else {
                document.exitFullscreen();
                document.body.classList.remove('presentation-mode');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initWorksheetSelect();
            const script = document.createElement('script');
            script.src = 'firebase-config.js';
            script.onload = () => { if (initFirebase()) console.log('Firebase ready'); };
            script.onerror = () => console.log('Firebase config not found, running in demo mode');
            document.head.appendChild(script);
        });
    </script>
</body>
</html>

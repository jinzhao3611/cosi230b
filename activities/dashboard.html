<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Response Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
        }

        .session-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .session-controls input, .session-controls select {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .session-controls input {
            width: 150px;
            text-transform: uppercase;
        }

        .session-controls select {
            min-width: 200px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .stats-bar {
            background: rgba(255,255,255,0.05);
            padding: 15px 40px;
            display: flex;
            gap: 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255,255,255,0.7);
        }

        .main-content {
            padding: 30px 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 .question-num {
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .question-subtitle {
            margin: -10px 0 15px;
            color: rgba(255,255,255,0.7);
            font-size: 0.95em;
            line-height: 1.3;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-bottom: 15px;
        }

        .agreement-metrics {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .metric {
            text-align: center;
            flex: 1;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .metric-value.excellent { color: #4CAF50; }
        .metric-value.good { color: #8BC34A; }
        .metric-value.moderate { color: #FFC107; }
        .metric-value.fair { color: #FF9800; }
        .metric-value.poor { color: #f44336; }

        .metric-label {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
        }

        .text-responses {
            max-height: 300px;
            overflow-y: auto;
        }

        .text-response {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.95em;
            line-height: 1.5;
            border-left: 3px solid #4CAF50;
        }

        .text-response:nth-child(even) {
            border-left-color: #2196F3;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #4CAF50;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            backdrop-filter: blur(10px);
        }

        .fullscreen-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        body.presentation-mode .header {
            padding: 10px 20px;
        }

        body.presentation-mode .main-content {
            padding: 15px 20px;
        }

        body.presentation-mode .card {
            padding: 15px;
        }

        .connection-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 40px;
        }

        .empty-state h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: rgba(255,255,255,0.8);
        }

        .empty-state p {
            color: rgba(255,255,255,0.5);
            font-size: 1.1em;
            max-width: 500px;
            margin: 0 auto;
        }

        .session-code-display {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 8px;
            color: #4CAF50;
            text-align: center;
            padding: 20px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.7;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .session-list {
            margin-top: 20px;
        }

        .session-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .session-item:hover {
            background: rgba(255,255,255,0.08);
        }

        .session-info {
            flex: 1;
        }

        .session-code {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            letter-spacing: 2px;
        }

        .session-meta {
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }

        .session-worksheets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .worksheet-tag {
            background: rgba(33, 150, 243, 0.3);
            color: #90caf9;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }

        .session-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .no-sessions {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.5);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .storage-info {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .storage-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .storage-bar-fill {
            height: 100%;
            background: #4CAF50;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .confirm-dialog {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .confirm-dialog p {
            margin-bottom: 15px;
        }

        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Annotation Worksheet Dashboard</h1>
        <div class="session-controls">
            <input type="text" id="sessionCode" placeholder="Session Code" maxlength="6">
            <select id="worksheetSelect">
                <option value="">Select Worksheet...</option>
            </select>
            <button class="btn btn-primary" onclick="startSession()">Start Viewing</button>
            <button class="btn btn-secondary" onclick="generateSessionCode()">New Session</button>
            <button class="btn btn-warning" onclick="openSessionManager()">Manage Sessions</button>
            <span class="connection-status disconnected" id="connectionStatus">Disconnected</span>
        </div>
    </div>

    <div class="stats-bar" id="statsBar" style="display: none;">
        <div class="stat-item">
            <div class="stat-value" id="totalResponses">0</div>
            <div class="stat-label">Total Responses</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgAgreement">--</div>
            <div class="stat-label">Avg. Agreement</div>
        </div>
        <div class="stat-item">
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="stat-label" id="lastUpdate">Waiting for responses...</div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="empty-state">
            <h2>Welcome to the Dashboard</h2>
            <p>Enter a session code and select a worksheet to view real-time student responses and statistics.</p>
            <p style="margin-top: 20px;">Or click "New Session" to generate a new session code for your class.</p>
        </div>
    </div>

    <button class="fullscreen-btn" onclick="toggleFullscreen()">&#x26F6; Fullscreen</button>

    <!-- Session Manager Modal -->
    <div class="modal-overlay" id="sessionModal">
        <div class="modal">
            <h2>
                Session Manager
                <button class="modal-close" onclick="closeSessionManager()">&times;</button>
            </h2>

            <div class="storage-info">
                <strong>Storage Usage</strong>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span id="storageUsed">Calculating...</span>
                    <span style="color: rgba(255,255,255,0.5);">Free tier: 1 GB</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-bar-fill" id="storageBar" style="width: 0%"></div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>All Sessions</h3>
                <button class="btn btn-danger btn-sm" onclick="confirmDeleteAll()" id="deleteAllBtn" style="display: none;">Delete All Sessions</button>
            </div>

            <div class="session-list" id="sessionList">
                <div class="loading"></div>
            </div>

            <div class="confirm-dialog" id="confirmDialog" style="display: none;">
                <p id="confirmMessage">Are you sure you want to delete this session? This cannot be undone.</p>
                <div class="confirm-actions">
                    <button class="btn btn-secondary btn-sm" onclick="cancelDelete()">Cancel</button>
                    <button class="btn btn-danger btn-sm" onclick="executeDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Worksheet definitions
        const worksheets = {
            'toxicity': { name: 'Toxicity Detection', file: 'toxicity-worksheet.html' },
            'event-extraction': { name: 'Event Extraction', file: 'event-extraction-worksheet.html' },
            'causal-relation': { name: 'Causal Relation', file: 'causal-relation-worksheet.html' },
            'ner': { name: 'Named Entity Recognition', file: 'ner-worksheet.html' },
            'sentiment': { name: 'Sentiment Analysis', file: 'sentiment-worksheet.html' },
            'coreference': { name: 'Coreference Resolution', file: 'coreference-worksheet.html' },
            'llm-preference': { name: 'LLM Preference (RLHF)', file: 'llm-preference-worksheet.html' },
            'hallucination': { name: 'Hallucination Detection', file: 'hallucination-worksheet.html' },
            'sarcasm': { name: 'Sarcasm Detection', file: 'sarcasm-worksheet.html' },
            'stance-detection': { name: 'Stance Detection', file: 'stance-detection-worksheet.html' },
            'qa-annotation': { name: 'Question Answering', file: 'qa-annotation-worksheet.html' },
            'summarization-eval': { name: 'Summarization Evaluation', file: 'summarization-eval-worksheet.html' },
            'emotion-detection': { name: 'Emotion Detection', file: 'emotion-detection-worksheet.html' },
            'semantic-role': { name: 'Semantic Role Labeling', file: 'semantic-role-worksheet.html' },
            'prompt-quality': { name: 'Prompt Quality', file: 'prompt-quality-worksheet.html' },
            'word-sense': { name: 'Word Sense Disambiguation', file: 'word-sense-worksheet.html' },
            'dialogue-act': { name: 'Dialogue Act Classification', file: 'dialogue-act-worksheet.html' },
            'temporal-annotation': { name: 'Temporal Annotation', file: 'temporal-annotation-worksheet.html' },
            'implicit-hate': { name: 'Implicit Hate Speech', file: 'implicit-hate-worksheet.html' },
            'translation-quality': { name: 'Translation Quality', file: 'translation-quality-worksheet.html' },
            'code-review': { name: 'Code Review', file: 'code-review-worksheet.html' },
            'relation-extraction': { name: 'Relation Extraction', file: 'relation-extraction-worksheet.html' },
            'argumentation': { name: 'Argumentation Mining', file: 'argumentation-worksheet.html' },
            'text-simplification': { name: 'Text Simplification', file: 'text-simplification-worksheet.html' },
            'bias-detection': { name: 'Bias Detection', file: 'bias-detection-worksheet.html' }
        };

        const chartColors = [
            'rgba(76, 175, 80, 0.8)',
            'rgba(33, 150, 243, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(156, 39, 176, 0.8)',
            'rgba(255, 87, 34, 0.8)',
            'rgba(0, 188, 212, 0.8)',
            'rgba(233, 30, 99, 0.8)',
            'rgba(139, 195, 74, 0.8)'
        ];

        let db = null;
        let unsubscribe = null;
        let currentSession = null;
        let currentWorksheet = null;
        let charts = {};
        let allResponses = [];
        let deleteTarget = null;
        const worksheetMetaCache = {};

        // Initialize worksheet dropdown
        function initWorksheetSelect() {
            const select = document.getElementById('worksheetSelect');
            Object.entries(worksheets).forEach(([id, info]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = info.name;
                select.appendChild(option);
            });
        }

        // Generate random session code
        function generateSessionCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('sessionCode').value = code;

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <h2>Session Created!</h2>
                    <p>Share this code with your students:</p>
                    <div class="session-code-display">${code}</div>
                    <p style="margin-top: 20px;">Students should enter this code in their worksheet before submitting.</p>
                    <p style="margin-top: 10px;">Select a worksheet above and click "Start Viewing" to begin.</p>
                </div>
            `;
        }

        // Initialize Firebase
        function initFirebase() {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase initialized');
                return true;
            } else {
                console.warn('Firebase config not found');
                return false;
            }
        }

        // Session Manager Functions
        function openSessionManager() {
            document.getElementById('sessionModal').classList.add('show');
            const code = document.getElementById('sessionCode').value.toUpperCase().trim();
            if (code) {
                ensureSessionDocument(code).finally(loadAllSessions);
                return;
            }
            loadAllSessions();
        }

        function closeSessionManager() {
            document.getElementById('sessionModal').classList.remove('show');
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function loadAllSessions() {
            const sessionList = document.getElementById('sessionList');
            sessionList.innerHTML = '<div class="loading"></div>';

            if (!db) {
                sessionList.innerHTML = '<div class="no-sessions">Firebase not configured. Running in demo mode.</div>';
                document.getElementById('storageUsed').textContent = 'Demo mode - no data stored';
                return;
            }

            try {
                const sessionsRef = db.collection('sessions');
                const sessionsSnapshot = await sessionsRef.get();

                if (sessionsSnapshot.empty) {
                    sessionList.innerHTML = '<div class="no-sessions">No sessions found. Create a new session to get started.</div>';
                    document.getElementById('storageUsed').textContent = '0 sessions, 0 responses';
                    document.getElementById('deleteAllBtn').style.display = 'none';
                    return;
                }

                const sessions = [];
                let totalResponses = 0;

                const worksheetIds = Object.keys(worksheets);

                for (const sessionDoc of sessionsSnapshot.docs) {
                    const sessionCode = sessionDoc.id;
                    const worksheetData = [];

                    for (const worksheetId of worksheetIds) {
                        const worksheetSnap = await db.collection('sessions')
                            .doc(sessionCode)
                            .collection(worksheetId)
                            .get();
                        const count = worksheetSnap.size;
                        totalResponses += count;
                        if (count > 0) {
                            worksheetData.push({
                                id: worksheetId,
                                name: worksheets[worksheetId]?.name || worksheetId,
                                count: count
                            });
                        }
                    }

                    if (worksheetData.length > 0) {
                        sessions.push({
                            code: sessionCode,
                            worksheets: worksheetData,
                            totalResponses: worksheetData.reduce((sum, w) => sum + w.count, 0)
                        });
                    }
                }

                // Update storage info
                document.getElementById('storageUsed').textContent = `${sessions.length} session(s), ${totalResponses} total responses`;
                const storagePercent = Math.min((totalResponses * 0.001), 100); // Rough estimate
                document.getElementById('storageBar').style.width = storagePercent + '%';

                if (sessions.length === 0) {
                    sessionList.innerHTML = '<div class="no-sessions">No sessions with data found.</div>';
                    document.getElementById('deleteAllBtn').style.display = 'none';
                    return;
                }

                document.getElementById('deleteAllBtn').style.display = 'block';

                // Render sessions
                sessionList.innerHTML = sessions.map(session => `
                    <div class="session-item">
                        <div class="session-info">
                            <div class="session-code">${session.code}</div>
                            <div class="session-meta">${session.totalResponses} responses</div>
                            <div class="session-worksheets">
                                ${session.worksheets.map(w => `<span class="worksheet-tag">${w.name} (${w.count})</span>`).join('')}
                            </div>
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewSession('${session.code}', '${session.worksheets[0]?.id || ''}')">View</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteSession('${session.code}')">Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading sessions:', error);
                sessionList.innerHTML = '<div class="no-sessions">Error loading sessions. Check console for details.</div>';
            }
        }

        function viewSession(code, worksheetId) {
            document.getElementById('sessionCode').value = code;
            if (worksheetId) {
                document.getElementById('worksheetSelect').value = worksheetId;
            }
            closeSessionManager();
            if (worksheetId) {
                startSession();
            }
        }

        function confirmDeleteSession(code) {
            deleteTarget = { type: 'session', code: code };
            document.getElementById('confirmMessage').textContent =
                `Are you sure you want to delete session "${code}" and all its responses? This cannot be undone.`;
            document.getElementById('confirmDialog').style.display = 'block';
        }

        function confirmDeleteAll() {
            deleteTarget = { type: 'all' };
            document.getElementById('confirmMessage').textContent =
                'Are you sure you want to delete ALL sessions and responses? This cannot be undone.';
            document.getElementById('confirmDialog').style.display = 'block';
        }

        function cancelDelete() {
            deleteTarget = null;
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function executeDelete() {
            if (!deleteTarget || !db) return;

            document.getElementById('confirmDialog').style.display = 'none';
            document.getElementById('sessionList').innerHTML = '<div class="loading"></div>';

            try {
                if (deleteTarget.type === 'session') {
                    await deleteSession(deleteTarget.code);
                } else if (deleteTarget.type === 'all') {
                    const sessionsSnapshot = await db.collection('sessions').get();
                    for (const doc of sessionsSnapshot.docs) {
                        await deleteSession(doc.id);
                    }
                }

                deleteTarget = null;
                loadAllSessions();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Error deleting session. Check console for details.');
                loadAllSessions();
            }
        }

        async function deleteSession(code) {
            const sessionRef = db.collection('sessions').doc(code);
            const worksheetIds = Object.keys(worksheets);
            for (const worksheetId of worksheetIds) {
                const docs = await sessionRef.collection(worksheetId).get();
                if (docs.empty) continue;
                const batch = db.batch();
                docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }

            await sessionRef.delete();
        }

        // Start viewing session
        async function startSession() {
            const sessionCode = document.getElementById('sessionCode').value.toUpperCase().trim();
            const worksheetId = document.getElementById('worksheetSelect').value;

            if (!sessionCode) {
                alert('Please enter a session code');
                return;
            }

            if (!worksheetId) {
                alert('Please select a worksheet');
                return;
            }

            if (!db) {
                await startDemoMode(sessionCode, worksheetId);
                return;
            }

            currentSession = sessionCode;
            currentWorksheet = worksheetId;
            await ensureSessionDocument(sessionCode);
            await ensureWorksheetMeta(currentWorksheet);

            if (unsubscribe) {
                unsubscribe();
            }

            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').textContent = 'Connected';

            unsubscribe = db.collection('sessions')
                .doc(sessionCode)
                .collection(worksheetId)
                .onSnapshot((snapshot) => {
                    allResponses = [];
                    snapshot.forEach(doc => {
                        allResponses.push(doc.data());
                    });
                    updateDashboard(allResponses);
                }, (error) => {
                    console.error('Error listening to updates:', error);
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = 'Error';
                });
        }

        async function startDemoMode(sessionCode, worksheetId) {
            currentSession = sessionCode;
            currentWorksheet = worksheetId;
            await ensureWorksheetMeta(currentWorksheet);

            document.getElementById('statsBar').style.display = 'flex';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').textContent = 'Demo Mode';

            const demoResponses = generateDemoData(worksheetId);
            allResponses = demoResponses;
            updateDashboard(demoResponses);

            setInterval(() => {
                if (Math.random() > 0.7) {
                    allResponses.push(generateSingleDemoResponse(worksheetId));
                    updateDashboard(allResponses);
                }
            }, 3000);
        }

        function generateDemoData(worksheetId) {
            const responses = [];
            const numResponses = Math.floor(Math.random() * 15) + 10;
            for (let i = 0; i < numResponses; i++) {
                responses.push(generateSingleDemoResponse(worksheetId));
            }
            return responses;
        }

        function generateSingleDemoResponse(worksheetId) {
            const response = { timestamp: new Date().toISOString(), answers: {} };
            for (let i = 1; i <= 8; i++) {
                if (Math.random() < 0.7) {
                    const options = ['A', 'B', 'C', 'D'];
                    response.answers[`q${i}`] = options[Math.floor(Math.random() * options.length)];
                } else {
                    const texts = ["The context makes it ambiguous.", "Clear case.", "Multiple valid interpretations.", "Guidelines unclear."];
                    response.answers[`q${i}_text`] = texts[Math.floor(Math.random() * texts.length)];
                }
            }
            return response;
        }

        function updateDashboard(responses) {
            document.getElementById('totalResponses').textContent = responses.length;
            document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;

            if (responses.length === 0) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="empty-state">
                        <h2>Waiting for Responses</h2>
                        <p>Session Code: <strong>${currentSession}</strong></p>
                        <p>Worksheet: <strong>${worksheets[currentWorksheet].name}</strong></p>
                        <p style="margin-top: 20px;">Responses will appear here in real-time as students submit.</p>
                    </div>
                `;
                return;
            }

            const analysis = analyzeResponses(responses);
            renderDashboard(analysis);
            document.getElementById('avgAgreement').textContent = analysis.avgAgreement.toFixed(0) + '%';
        }

        function analyzeResponses(responses) {
            const questions = {};
            const textResponses = {};
            const answersByQuestion = {};

            responses.forEach(response => {
                Object.entries(response.answers || {}).forEach(([key, value]) => {
                    if (key.endsWith('_text')) {
                        const qKey = key.replace('_text', '');
                        if (!textResponses[qKey]) textResponses[qKey] = [];
                        if (value && value.trim()) textResponses[qKey].push(value);
                    } else if (key.startsWith('other_')) {
                        // Treat free-text "other" inputs as text responses instead of categorical values.
                        if (!textResponses[key]) textResponses[key] = [];
                        if (value && String(value).trim()) textResponses[key].push(String(value).trim());
                    } else {
                        if (!questions[key]) questions[key] = {};
                        if (!answersByQuestion[key]) answersByQuestion[key] = [];

                        if (Array.isArray(value)) {
                            // Checkbox groups: count each selected option.
                            value.forEach(v => {
                                if (!questions[key][v]) questions[key][v] = 0;
                                questions[key][v]++;
                            });
                            answersByQuestion[key].push(value);
                        } else {
                            if (!questions[key][value]) questions[key][value] = 0;
                            questions[key][value]++;
                            answersByQuestion[key].push(value);
                        }
                    }
                });
            });

            let totalAgreement = 0, questionCount = 0;

            const questionIds = new Set([...Object.keys(questions), ...Object.keys(textResponses)]);
            const questionAnalysis = Array.from(questionIds).map((qId) => {
                const distribution = questions[qId] || {};
                const total = Object.values(distribution).reduce((a, b) => a + b, 0);
                const options = Object.keys(distribution).sort();
                const counts = options.map(opt => distribution[opt] || 0);
                const answers = answersByQuestion[qId] || [];
                const isMultiSelect = answers.some(a => Array.isArray(a));
                const agreement = isMultiSelect
                    ? calculateMultiSelectAgreement(answers)
                    : calculateSingleSelectAgreement(counts, answers.length);

                if (answers.length > 1) {
                    totalAgreement += agreement;
                    questionCount++;
                }

                return { id: qId, distribution, options, counts, total, agreement, responseCount: answers.length, textResponses: textResponses[qId] || [] };
            });

            return {
                questions: questionAnalysis.sort((a, b) => getQuestionOrder(currentWorksheet, a.id) - getQuestionOrder(currentWorksheet, b.id)),
                avgAgreement: questionCount > 0 ? totalAgreement / questionCount : 0,
                totalResponses: responses.length
            };
        }

        function calculateSingleSelectAgreement(counts, totalResponses) {
            if (totalResponses < 2 || counts.length === 0) return 0;
            const maxCount = Math.max(...counts);
            return (maxCount / totalResponses) * 100;
        }

        function calculateMultiSelectAgreement(answers) {
            const valid = answers.filter(a => Array.isArray(a));
            if (valid.length < 2) return 0;
            let sum = 0;
            let pairs = 0;
            for (let i = 0; i < valid.length; i++) {
                const setA = new Set(valid[i]);
                for (let j = i + 1; j < valid.length; j++) {
                    const setB = new Set(valid[j]);
                    const union = new Set([...setA, ...setB]);
                    let inter = 0;
                    setA.forEach(v => { if (setB.has(v)) inter++; });
                    const score = union.size === 0 ? 1 : inter / union.size;
                    sum += score;
                    pairs++;
                }
            }
            return (sum / pairs) * 100;
        }

        function getAgreementClass(agreement) {
            if (agreement >= 80) return 'excellent';
            if (agreement >= 60) return 'good';
            if (agreement >= 40) return 'moderate';
            if (agreement >= 20) return 'fair';
            return 'poor';
        }

        function renderDashboard(analysis) {
            const container = document.getElementById('mainContent');
            container.innerHTML = '';
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            analysis.questions.forEach((q) => {
                const card = document.createElement('div');
                card.className = 'card';
                const title = getQuestionTitle(currentWorksheet, q.id);
                const agreementClass = getAgreementClass(q.agreement);

                const subtitle = getQuestionSubtitle(currentWorksheet, q.id);
                const subtitleHtml = subtitle ? `<div class="question-subtitle">${escapeHtml(subtitle)}</div>` : '';

                if (q.options.length === 0) {
                    card.innerHTML = `
                        <h3><span class="question-num">${title}</span> Text Responses</h3>
                        ${subtitleHtml}
                        <div class="agreement-metrics">
                            <div class="metric"><div class="metric-value">${q.textResponses.length}</div><div class="metric-label">Responses</div></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="text-responses">${q.textResponses.map(t => `<div class="text-response">${escapeHtml(t)}</div>`).join('')}</div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <h3><span class="question-num">${title}</span> Response Distribution</h3>
                        ${subtitleHtml}
                        <div class="chart-container"><canvas id="chart-${q.id}"></canvas></div>
                        <div class="agreement-metrics">
                            <div class="metric"><div class="metric-value ${agreementClass}">${q.agreement.toFixed(0)}%</div><div class="metric-label">Agreement</div></div>
                            <div class="metric"><div class="metric-value">${q.responseCount}</div><div class="metric-label">Responses</div></div>
                        </div>
                        ${q.textResponses.length > 0 ? `
                            <div style="margin-top: 15px;"><h4 style="margin-bottom: 10px; color: rgba(255,255,255,0.8);">Text Responses</h4>
                            <div class="text-responses">${q.textResponses.map(t => `<div class="text-response">${escapeHtml(t)}</div>`).join('')}</div></div>
                        ` : ''}
                    `;
                }
                container.appendChild(card);

                if (q.options.length > 0) {
                    const ctx = document.getElementById(`chart-${q.id}`).getContext('2d');
                    charts[q.id] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: q.options.map(opt => formatOptionLabel(currentWorksheet, q.id, opt)),
                            datasets: [{ data: q.counts, backgroundColor: q.options.map((_, i) => chartColors[i % chartColors.length]), borderWidth: 0, borderRadius: 5 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.7)', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: 'rgba(255,255,255,0.9)' }, grid: { display: false } }
                            }
                        }
                    });
                }
            });
        }

        function getQuestionOrder(worksheetId, qId) {
            const order = getQuestionMeta(worksheetId)?.order || [];
            const idx = order.indexOf(qId);
            return idx >= 0 ? idx : 9999;
        }

        function getQuestionTitle(worksheetId, qId) {
            const titles = getQuestionMeta(worksheetId)?.titles || {};
            return titles[qId] || `Q ${qId}`;
        }

        function getQuestionSubtitle(worksheetId, qId) {
            const subtitles = getQuestionMeta(worksheetId)?.subtitles || {};
            return subtitles[qId] || '';
        }

        function formatOptionLabel(worksheetId, qId, opt) {
            const optionLabels = getQuestionMeta(worksheetId)?.optionLabels || {};
            if (optionLabels[qId] && optionLabels[qId][opt]) return optionLabels[qId][opt];
            return String(opt).replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        function getQuestionMeta(worksheetId) {
            if (worksheetId === 'toxicity') {
                return {
                order: [
                    'q1',
                    'textarea_0',
                    'ex1', 'textarea_1', 'textarea_2',
                    'ex2', 'textarea_3', 'textarea_4',
                    'ex3', 'textarea_5', 'textarea_6',
                    'ex4', 'textarea_7', 'textarea_8',
                    'ex5', 'textarea_9', 'textarea_10',
                    'disagreement', 'causes', 'other_0',
                    'q4', 'textarea_11',
                    'q5', 'textarea_12',
                    'q6',
                    'textarea_13'
                ],
                titles: {
                    q1: 'Q1: Label Definition (Sufficiency)',
                    textarea_0: 'Q1: Why or Why Not?',
                    ex1: 'Example 1: Label',
                    textarea_1: 'Example 1: Reasoning',
                    textarea_2: 'Example 1: Uncertainty',
                    ex2: 'Example 2: Label',
                    textarea_3: 'Example 2: Reasoning',
                    textarea_4: 'Example 2: Uncertainty',
                    ex3: 'Example 3: Label',
                    textarea_5: 'Example 3: Reasoning',
                    textarea_6: 'Example 3: Uncertainty',
                    ex4: 'Example 4: Label',
                    textarea_7: 'Example 4: Reasoning',
                    textarea_8: 'Example 4: Uncertainty',
                    ex5: 'Example 5: Label',
                    textarea_9: 'Example 5: Reasoning',
                    textarea_10: 'Example 5: Uncertainty',
                    disagreement: 'Q2: Disagreement Examples',
                    causes: 'Q3: Causes of Disagreement',
                    other_0: 'Q3: Other Cause (Text)',
                    q4: 'Q4: Dataset Decision',
                    textarea_11: 'Q4: Explanation',
                    q5: 'Q5: Guideline Change',
                    textarea_12: 'Q5: Explanation',
                    q6: 'Q6: Why Task Is Difficult',
                    textarea_13: 'Q7: Consequences if Unresolved'
                },
                subtitles: {
                    q1: 'Part 1 — Are these definitions sufficient to label comments consistently?',
                    textarea_0: 'Part 1 — Explain why or why not',
                    ex1: 'Part 2 — "Wow, great job."',
                    textarea_1: 'Part 2 — Example 1 reasoning',
                    textarea_2: 'Part 2 — Example 1 uncertainty',
                    ex2: 'Part 2 — "Nice work, genius."',
                    textarea_3: 'Part 2 — Example 2 reasoning',
                    textarea_4: 'Part 2 — Example 2 uncertainty',
                    ex3: 'Part 2 — "This idea is stupid."',
                    textarea_5: 'Part 2 — Example 3 reasoning',
                    textarea_6: 'Part 2 — Example 3 uncertainty',
                    ex4: 'Part 2 — "Sure, that’ll work. Just like last time."',
                    textarea_7: 'Part 2 — Example 4 reasoning',
                    textarea_8: 'Part 2 — Example 4 uncertainty',
                    ex5: 'Part 2 — "I can’t believe you actually think this makes sense."',
                    textarea_9: 'Part 2 — Example 5 reasoning',
                    textarea_10: 'Part 2 — Example 5 uncertainty',
                    disagreement: 'Part 3 — Which examples had disagreement?',
                    causes: 'Part 3 — What caused the disagreement?',
                    other_0: 'Part 3 — Other cause (text)',
                    q4: 'Part 4 — How should this example be handled in the dataset?',
                    textarea_11: 'Part 4 — Explain your choice',
                    q5: 'Part 5 — Guideline change to reduce disagreement?',
                    textarea_12: 'Part 5 — Explain your choice',
                    q6: 'Part 6 — Why is this task difficult?',
                    textarea_13: 'Part 6 — Consequences if disagreement unresolved'
                },
                optionLabels: {
                    q1: { yes: 'Yes', no: 'No' },
                    ex1: { 'toxic': 'Toxic', 'not-toxic': 'Not Toxic' },
                    ex2: { 'toxic': 'Toxic', 'not-toxic': 'Not Toxic' },
                    ex3: { 'toxic': 'Toxic', 'not-toxic': 'Not Toxic' },
                    ex4: { 'toxic': 'Toxic', 'not-toxic': 'Not Toxic' },
                    ex5: { 'toxic': 'Toxic', 'not-toxic': 'Not Toxic' },
                    disagreement: { ex1: 'Example 1', ex2: 'Example 2', ex3: 'Example 3', ex4: 'Example 4', ex5: 'Example 5' },
                    causes: {
                        sarcasm: 'Sarcasm or irony',
                        context: 'Lack of context',
                        hostile: 'Interpretation of hostile',
                        thresholds: 'Different personal thresholds',
                        guidelines: 'Unclear guidelines',
                        other: 'Other'
                    },
                    q4: {
                        majority: 'Use the majority label',
                        remove: 'Remove the example',
                        ambiguous: 'Add an “Ambiguous” label',
                        uncertainty: 'Keep all labels + model uncertainty',
                        expert: 'Ask expert annotators'
                    },
                    q5: {
                        sarcasm: 'Rules about sarcasm',
                        'ideas-people': 'Ideas vs. people distinction',
                        context: 'Provide surrounding context',
                        categories: 'Add more label categories',
                        training: 'More annotator training'
                    },
                    q6: {
                        ambiguous: 'Language is ambiguous',
                        context: 'Meaning depends on context',
                        norms: 'Different personal norms',
                        definitions: 'Definitions are incomplete',
                        all: 'All of the above'
                    }
                }
                };
            }

            return worksheetMetaCache[worksheetId] || null;
        }

        async function ensureSessionDocument(sessionCode) {
            if (!db || !sessionCode) return;
            try {
                const payload = {
                    lastSeenAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('sessions').doc(sessionCode).set(payload, { merge: true });
            } catch (e) {
                console.warn('Failed to upsert session document:', e);
            }
        }

        async function ensureWorksheetMeta(worksheetId) {
            if (worksheetId === 'toxicity') return;
            if (worksheetMetaCache[worksheetId]) return;
            const file = worksheets[worksheetId]?.file;
            if (!file) return;
            try {
                const resp = await fetch(file, { cache: 'no-store' });
                if (!resp.ok) return;
                const html = await resp.text();
                worksheetMetaCache[worksheetId] = buildWorksheetMetaFromHtml(html);
            } catch (e) {
                console.warn('Failed to load worksheet metadata:', e);
            }
        }

        function buildWorksheetMetaFromHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const order = [];
            const titles = {};
            const subtitles = {};
            const optionLabels = {};

            const seenGroups = new Set();
            const inputs = doc.querySelectorAll('input[type="radio"], input[type="checkbox"], textarea, .other-input, select, input[type="text"]');
            const textareas = Array.from(doc.querySelectorAll('textarea'));
            const otherInputs = Array.from(doc.querySelectorAll('.other-input'));
            const textInputs = Array.from(doc.querySelectorAll('input[type="text"]'));
            const selects = Array.from(doc.querySelectorAll('select'));

            const addOrder = (id) => { if (!order.includes(id)) order.push(id); };

            inputs.forEach((el) => {
                if (el.tagName.toLowerCase() === 'textarea') {
                    const idx = textareas.indexOf(el);
                    const qId = `textarea_${idx}`;
                    addOrder(qId);
                    if (!titles[qId]) {
                        const labelText = findLabelText(el) || 'Text Response';
                        titles[qId] = labelText;
                    }
                    if (!subtitles[qId]) {
                        const subtitle = findContextSubtitle(el);
                        if (subtitle) subtitles[qId] = subtitle;
                    }
                    return;
                }

                if (el.tagName.toLowerCase() === 'select') {
                    const idx = selects.indexOf(el);
                    const name = el.getAttribute('name') || el.getAttribute('id') || `select_${idx}`;
                    addOrder(name);
                    if (!titles[name]) {
                        const rowLabel = findRowLabel(el);
                        const header = findContextHeader(el);
                        titles[name] = rowLabel || header || `Question ${name}`;
                    }
                    if (!subtitles[name]) {
                        const subtitle = findContextSubtitle(el);
                        if (subtitle) subtitles[name] = subtitle;
                    }
                    if (!optionLabels[name]) optionLabels[name] = {};
                    el.querySelectorAll('option').forEach(opt => {
                        const value = opt.value || opt.textContent;
                        const label = opt.textContent.replace(/\s+/g, ' ').trim();
                        if (label) optionLabels[name][value] = label;
                    });
                    return;
                }

                if (el.classList.contains('other-input')) {
                    const idx = otherInputs.indexOf(el);
                    const qId = `other_${idx}`;
                    addOrder(qId);
                    if (!titles[qId]) titles[qId] = 'Other (Text)';
                    if (!subtitles[qId]) {
                        const subtitle = findContextSubtitle(el);
                        if (subtitle) subtitles[qId] = subtitle;
                    }
                    return;
                }

                if (el.tagName.toLowerCase() === 'input' && el.type === 'text') {
                    const idx = textInputs.indexOf(el);
                    const qId = `${el.getAttribute('name') || el.getAttribute('id') || `textinput_${idx}`}_text`;
                    addOrder(qId);
                    if (!titles[qId]) {
                        const rowLabel = findRowLabel(el);
                        const labelText = findLabelText(el);
                        const header = findContextHeader(el);
                        titles[qId] = rowLabel || labelText || header || 'Text Response';
                    }
                    if (!subtitles[qId]) {
                        const subtitle = findContextSubtitle(el);
                        if (subtitle) subtitles[qId] = subtitle;
                    }
                    return;
                }

                const name = el.getAttribute('name');
                if (!name) return;
                if (!seenGroups.has(name)) {
                    addOrder(name);
                    seenGroups.add(name);
                    if (!titles[name]) {
                        const header = findContextHeader(el);
                        titles[name] = header || `Question ${name}`;
                    }
                    if (!subtitles[name]) {
                        const subtitle = findContextSubtitle(el);
                        if (subtitle) subtitles[name] = subtitle;
                    }
                }

                const value = el.getAttribute('value') || 'value';
                if (!optionLabels[name]) optionLabels[name] = {};
                const label = findOptionLabel(el);
                if (label) optionLabels[name][value] = label;
            });

            return { order, titles, subtitles, optionLabels };
        }

        function findOptionLabel(inputEl) {
            const label = inputEl.closest('label');
            if (!label) return '';
            const text = label.textContent.replace(/\s+/g, ' ').trim();
            return text || '';
        }

        function findLabelText(el) {
            const group = el.closest('.input-group');
            if (!group) return '';
            const label = group.querySelector('label');
            return label ? label.textContent.replace(/\s+/g, ' ').trim() : '';
        }

        function findContextHeader(el) {
            const container = el.closest('.question-box, .example-card, .section, .card, .question');
            if (!container) return '';
            const header = container.querySelector('.question-header, .example-header, h3, h2');
            return header ? header.textContent.replace(/\s+/g, ' ').trim() : '';
        }

        function findRowLabel(el) {
            const row = el.closest('tr');
            if (!row) return '';
            const cell = row.querySelector('th, td');
            if (!cell) return '';
            return cell.textContent.replace(/\s+/g, ' ').trim();
        }

        function findContextSubtitle(el) {
            const container = el.closest('.question-box, .example-card, .section, .card, .question');
            if (!container) return '';
            const comment = container.querySelector('.comment');
            if (comment) return comment.textContent.replace(/\s+/g, ' ').trim();
            const prompt = container.querySelector('p');
            if (prompt) return prompt.textContent.replace(/\s+/g, ' ').trim();
            return '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.body.classList.add('presentation-mode');
            } else {
                document.exitFullscreen();
                document.body.classList.remove('presentation-mode');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initWorksheetSelect();
            const script = document.createElement('script');
            script.src = 'firebase-config.js';
            script.onload = () => { if (initFirebase()) console.log('Firebase ready'); };
            script.onerror = () => console.log('Firebase config not found, running in demo mode');
            document.head.appendChild(script);
        });
    </script>
</body>
</html>
